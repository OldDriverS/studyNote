

# 基于conntrack mark标记的源进源出标记方案

## 什么是源进源出

![输入图片说明](../%E5%A4%9A%E8%B7%AF%E5%BE%84%E7%9A%84%E9%97%AE%E9%A2%98.png)

看上图，PC 认为这是一个连接，服务端则认为，这是一个新的连接


![输入图片说明](%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%8C%85%E5%8F%91%E9%80%81%E7%9A%84%E8%B7%AF%E5%BE%84.png)





# 配置测试

```
# 两个外网接口基础信息,以及lan网络接口信息
wan1: 192.168.1.10  网关 192.168.1.1 路由表
wan2: 192.168.2.10  网关 192.168.2.1 
lan: 192.168.10.1
```

fwmark 分配

```
wan1   2
wan2   3
```

需要从wan1出去的连接打上编号为2的标记，3对应的是wan2



## 路由表分配

```
# /etc/iproute2/rt_tables
251     wan1
252     wan2

255     local
254     main
253     default
0       unspec
```
路由表的最多有256张(0-255)，其中254 255默认被系统使用。

wan1 的默认路由设置在编号为251的路由表，路由表别名为wan1

wan2 的默认路由设置在编号为252的路由表，路由表别名为wan2


路由表最终是个数字，用rt_tables让它可读性增强


### 设置wan1路由表

```
ip route add 192.168.1.0/24  table wan1 dev wan1 
ip route add default via 192.168.1.1 table wan1  dev wan1 
```

### 设置wan2路由表

```
ip route add 192.168.2.0/24  table wan2 dev wan2
ip route add default via 192.168.2.1 table wan2  dev wan2
```

### 设置默认的表main（编号254）

```
ip route add 192.168.10.0/24 table main dev lan
ip route add 192.168.1.0/24  table main dev wan1 
ip route add 192.168.2.0/24  table main dev wan2
ip route add default scope global \
	nexthop via 192.168.1.1 dev wan1 weight 1 \
	nexthop via 192.168.2.1 dev wan2 weight 2 \
```

配置默认路由表均衡负载,wan1和wan2的发送流量比例是1:2



## 策略分配

**ip rule** 命令可以设置路由的查找策略，每一条规则由3部分组成

- 规则的优先级
- 匹配条件
- 匹配成功后的动作(跳转到特定的规则重新匹配，查找路由表)


priority数值越小，优先级越高，规则越先被匹配

如果在对应的路由表中没有找到相关的路由，则继续遍历规则

如果没有满足规则匹配条件则继续下一条。



### 优先级分配

- 0 查找local
- 251 满足 fwmark 1 时查找table 251
- 252 满足 fwmark 2 时查找table 252
- 253 








nftables 设置，eth0 和 eth1是两个外网的接口

```
# /etc/nftables.conf
table inet mangle {
        chain prerouting {
                type filter hook prerouting priority mangle; policy accept;
                ct state established meta mark set ct mark counter comment "已建立链接的ct标记恢复"
        }

        chain input-ct-mark {
                type filter hook input priority mangle; policy accept;
                iifname "wan1 ct state new ct mark set 2 counter  comment "eth0分流ct标记"
                iifname "wan2" ct state new ct mark set 3 counter comment "eht1分流ct标记"
        }

        chain postrouting-ct-mark {
                type filter hook postrouting priority mangle; policy accept;
                oifname "wan1" ct state new ct mark set 2 counter packets 3418 bytes 372630 comment "wifi分流ct标记"
                oifname "wan2" ct state new ct mark set 3 counter packets 245 bytes 42803 comment "zx3分流ct标记"
        }

        chain output {
                type filter hook output priority mangle; policy accept;
                ct state established meta mark set ct mark counter comment "已建立链接的ct标记恢复"
		}

```









